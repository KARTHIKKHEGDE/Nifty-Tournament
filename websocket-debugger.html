<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Token Debugger</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-radius: 5px;
        }
        .error { color: #f48771; }
        .success { color: #89d185; }
        .warning { color: #dcdcaa; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç WebSocket Token Debugger</h1>
    
    <div class="section">
        <h2>Step 1: Check Token in localStorage</h2>
        <button onclick="checkToken()">Check Token</button>
        <div id="tokenStatus"></div>
    </div>
    
    <div class="section">
        <h2>Step 2: Decode Token (Client-Side)</h2>
        <button onclick="decodeToken()">Decode Token</button>
        <div id="tokenDecoded"></div>
    </div>
    
    <div class="section">
        <h2>Step 3: Test WebSocket Connection</h2>
        <button onclick="testWebSocket()">Test Connection</button>
        <div id="wsStatus"></div>
    </div>
    
    <div class="section">
        <h2>Step 4: Login (if no token)</h2>
        <input type="email" id="email" placeholder="Email" value="test@example.com" style="padding: 8px; margin: 5px;">
        <input type="password" id="password" placeholder="Password" value="password123" style="padding: 8px; margin: 5px;">
        <button onclick="login()">Login</button>
        <div id="loginStatus"></div>
    </div>

    <script>
        function checkToken() {
            const token = localStorage.getItem('token');
            const statusDiv = document.getElementById('tokenStatus');
            
            if (!token) {
                statusDiv.innerHTML = '<p class="error">‚ùå No token found in localStorage</p><p>You need to login first!</p>';
            } else {
                statusDiv.innerHTML = `
                    <p class="success">‚úÖ Token found!</p>
                    <p>Length: ${token.length} characters</p>
                    <pre>${token.substring(0, 100)}...</pre>
                `;
            }
        }
        
        function decodeToken() {
            const token = localStorage.getItem('token');
            const decodedDiv = document.getElementById('tokenDecoded');
            
            if (!token) {
                decodedDiv.innerHTML = '<p class="error">‚ùå No token to decode</p>';
                return;
            }
            
            try {
                // Decode JWT (just the payload, not verifying signature)
                const parts = token.split('.');
                if (parts.length !== 3) {
                    decodedDiv.innerHTML = '<p class="error">‚ùå Invalid JWT format</p>';
                    return;
                }
                
                const payload = JSON.parse(atob(parts[1]));
                const now = Math.floor(Date.now() / 1000);
                const expired = payload.exp && payload.exp < now;
                
                decodedDiv.innerHTML = `
                    <p class="success">‚úÖ Token decoded successfully</p>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                    <p>User ID (sub): <strong>${payload.sub || 'MISSING!'}</strong></p>
                    <p>Expires: ${payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'No expiration'}</p>
                    <p class="${expired ? 'error' : 'success'}">${expired ? '‚ùå TOKEN EXPIRED!' : '‚úÖ Token valid (not expired)'}</p>
                `;
            } catch (e) {
                decodedDiv.innerHTML = `<p class="error">‚ùå Error decoding: ${e.message}</p>`;
            }
        }
        
        function testWebSocket() {
            const token = localStorage.getItem('token');
            const statusDiv = document.getElementById('wsStatus');
            
            if (!token) {
                statusDiv.innerHTML = '<p class="error">‚ùå No token - cannot connect</p>';
                return;
            }
            
            statusDiv.innerHTML = '<p class="warning">üîµ Connecting...</p>';
            
            const ws = new WebSocket(`ws://localhost:8000/ws?token=${token}`);
            
            ws.onopen = () => {
                statusDiv.innerHTML = '<p class="success">‚úÖ WebSocket connected successfully!</p>';
                ws.close();
            };
            
            ws.onerror = (error) => {
                statusDiv.innerHTML = `<p class="error">‚ùå WebSocket error: ${error}</p>`;
            };
            
            ws.onclose = (event) => {
                if (event.code === 1008) {
                    statusDiv.innerHTML = `<p class="error">‚ùå Connection closed: ${event.reason}</p><p>This means the backend rejected your token!</p>`;
                } else if (event.code === 1000) {
                    statusDiv.innerHTML += '<p class="success">Connection closed normally (test successful)</p>';
                } else {
                    statusDiv.innerHTML = `<p class="error">‚ùå Connection closed: Code ${event.code}, Reason: ${event.reason || 'unknown'}</p>`;
                }
            };
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('loginStatus');
            
            statusDiv.innerHTML = '<p class="warning">üîµ Logging in...</p>';
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    localStorage.setItem('token', data.access_token);
                    statusDiv.innerHTML = '<p class="success">‚úÖ Login successful! Token saved to localStorage</p>';
                    checkToken();
                } else {
                    statusDiv.innerHTML = `<p class="error">‚ùå Login failed: ${data.detail || 'Unknown error'}</p>`;
                }
            } catch (e) {
                statusDiv.innerHTML = `<p class="error">‚ùå Error: ${e.message}</p>`;
            }
        }
        
        // Auto-check on load
        window.onload = () => {
            checkToken();
        };
    </script>
</body>
</html>
